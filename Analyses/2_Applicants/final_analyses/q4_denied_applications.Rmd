---
title: "PAWS Denied Applications Analysis"
author: "Veena"
date: "3/23/2019"
always_allow_html: yes
output: 
  github_document:
    toc: true 
    df_print: kable
---

2. Describe an adoption application's trajectory at PAWS <br>
2.4 What are the applicant and animal characteristics that predict a denied application?


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F)
```

```{r scipen, echo = F,  message = F,  warning = T}
# Turn off scientific notation ----
options(scipen=999) #digits = 2
```

##Load Packages
```{r load_packages, echo = T, message=F, warning=F}
#load packages
library(readr)
library(dplyr)
library(tidyr)

library(tidyverse)
library(lubridate)
library(skimr) 
library(gtools)
library(knitr)  #for outputting tables as kables
library(cowplot)
```

##Load Data
```{r load_data, echo = T,  message = F,  warning = T}
apps_cards <- readRDS("../appsCards.rds")

masterData <- readRDS("../masterapps_20190324.rds")
```

##Explore Data
```{r explore_data, echo = T,  message = F,  warning = T}
dim(apps_cards)
dim(masterData)
is.data.frame(apps_cards)
#summary(apps_cards)

#select(apps_cards, matches("denied")) #label.names_denied_ind
#select(apps_cards, matches("withdraw")) #label.names_withdrawn_ind
#select(apps_cards, matches("red")) #label.names_red.flag_ind

dplyr::count(apps_cards, label.names_denied_ind) #how many applications were denied; 12 denied
dplyr::count(apps_cards, label.names_withdrawn_ind) #19 withdrawn
dplyr::count(apps_cards, label.names_red.flag_ind) #133 red flagged

#colnames(apps_cards)

df_denied <- dplyr::filter(apps_cards, label.names_denied_ind == 1)
df_redflag <- dplyr::filter(masterData, label.names_red.flag_ind == 1)
#df_withdrawn <- dplyr::filter(apps_cards, label.names_withdrawn_ind == 1)
dim(df_denied)
dim(df_redflag)
```

##Visualization and further analysis for applications that were denied

<br> There were 12 applications that were denied and 19 that were withdrawn. The analysis below shows the characteristics of the applications that were denied. Below are visualizations that show the budget, allergies, home owner, home pet policy, and experience breakdown for denied applications.
<br>
<pre>Key takeaways:
- No allergies for the denied application
- Budget has no impact on denied application, approved applications were similar
- All household members agreed
- Majority did not enter the home pet policy and not everyone is the home owner
- Many of the denied applications had unfortunate prior experiences
</pre>

``` {r denied and withdrawn, echo=T, message=F, warning=T}
#budget, all household agree, allergies, homeowner, home pet policy (lot of NA), experience
ggplot(df_denied, aes(x=budget_monthly_ranges)) + 
  geom_bar(aes(fill=animal_type), width=.5) +
  ggtitle("Budget for Denied Applications") +
  labs(x = "Budget Range ($)",                                                            
       y= "Count",
       fill = "Animal Type") +
  coord_cartesian(ylim=c(0, 10))

ggplot(df_denied, aes(x=allergies)) + 
  geom_bar(aes(fill=animal_type), width=.5) +
  ggtitle("Allergy Status for Denied Applications") +
  labs(x = "Allergies",                                                            
       y= "Count",
       fill = "Animal Type") +
  coord_cartesian(ylim=c(0, 15))

ggplot(df_denied, aes(x=all_household_agree)) + 
  geom_bar(aes(fill=animal_type), width=.5) +
  ggtitle("Household Agrees Status for Denied Applications") +
  labs(x = "Household Agrees",                                                            
       y= "Count",
       fill = "Animal Type") +
  coord_cartesian(ylim=c(0, 15))

g1 <- ggplot(df_denied, aes(x=home_owner)) + 
  geom_bar(aes(fill=animal_type), width=.5) +
  labs(y= "Count",
       fill = "Animal Type") +
  coord_cartesian(ylim=c(0, 10)) +
  theme(axis.text.x = element_text(angle=50, vjust=0.5))

g2 <- ggplot(df_denied, aes(x=home_pet_policy)) + 
  geom_bar(aes(fill=animal_type), width=.5) +
  labs(fill = "Animal Type") +
  coord_cartesian(ylim=c(0, 10)) +
  theme(axis.text.x = element_text(angle=50, vjust=0.5))

theme_set(theme_cowplot(font_size=12))
plot_grid(g1, g2, align='h')

#home along average; varies too much
ggplot(df_denied, aes(x=home_alone_avg)) + 
  geom_bar(aes(fill=animal_type), width=.5) +
  ggtitle("Home Along Avg for Denied Applications") +
  labs(x = "Hours",                                                            
       y= "Count",
       fill = "Animal Type") +
  coord_cartesian(ylim=c(0, 15))

#trying to get all the experiences to show in one chart
#df_exp <- dplyr::count(df_denied, experience) #frequency of experiences for all denied applications
#df_exp[order(df_exp$n, decreasing=TRUE),]
experience_summary <- df_denied %>%
  select(starts_with("experience_")) %>% 
  summarise_all(sum, na.rm = TRUE) %>%
  gather() %>%
  mutate(cleaned_col = str_replace(key, "experience_", ""),
         cleaned_col = str_replace(cleaned_col, "_ind", "")) %>%
  select(cleaned_col, value)

ggplot(experience_summary, aes(x= fct_reorder(cleaned_col, value, .desc=TRUE), y=value)) + 
  geom_bar(stat = "identity", fill="#78aac3") +
  theme(axis.text.x = element_text(angle=50, vjust=0.5)) +
  guides(fill=FALSE) +
  ggtitle("Prior Experiences for Denied Applications") +
  labs(x = "Experience", y= "Count")

```


##Visualization and further analysis for applications that are red flagged
```{r red flag, echo = T,  message = F,  warning = T}

#For the applications that are red flgged, how many end up becoming adopted

#Time difference between when they were adopted and application submission date

```